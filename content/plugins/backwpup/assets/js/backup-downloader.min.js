;window.BWU=window.BWU||{};(function(e,s,t,i,d){var n,a,u;t.Restore=t.Restore||{};t.Restore.Functions=t.Restore.Functions||{removeMessages:function(){e(document.body).find('#bwu_response').remove()},printMessageError:function(t,s){var i=e(s);if(!t){return};this.removeMessages();i.append('<p id="bwu_response" class="response response-error">'+t+'</p>')},printMessageSuccess:function(t,s){var i=e(s);if(!t){return};this.removeMessages();i.append('<p id="bwu_response" class="response response-success">'+t+'</p>')},loadNextStep:function(e,t){var s='step='+e;location.replace(location.origin+location.pathname+'?'+s+'&page=backwpuprestore&backwpup_action_nonce='+t)},calculatePercentage:function(e,t){var s=e/t;return Math.round(s*100)},makeConstant:function(e){return{value:e,writable:!1,configurable:!1,enumerable:!1}}};t.States=t.States||Object.create({},{DONE:t.Restore.Functions.makeConstant('done'),DOWNLOADING:t.Restore.Functions.makeConstant('downloading'),NEED_DECRYPTION_KEY:t.Restore.Functions.makeConstant('need_decryption_key')});if(!i){console.warn('Missing ajaxurl value.');return};if(!('EventSource' in window)){console.warn('Event Source does not exist in this browser');return};function r(){this.closeEventSource();this.cleanUi();this.decrypter&&this.decrypter.destruct()};function o(e){if(!e){return};e.style.display='none'};function c(e){if(!e){return};e.style.display='block'};u={showWaitingMessage:function(){c(this.waitingUi)},showProgressUi:function(){c(this.progressUi)},showSuccessMsg:function(){c(this.successUi)},hideWaitingMessage:function(){o(this.waitingUi)},hideProgressUi:function(){o(this.progressUi)},hideNotice:function(){t.Restore.Functions.removeMessages(this.containerUi)},hideSuccessMsg:function(){o(this.successUi)},cleanUi:function(){this.hideWaitingMessage();this.hideProgressUi();this.hideNotice();this.hideSuccessMsg();this.decrypter&&this.decrypter.hide()},done:function(){this.showSuccessMsg();window.location.href=this.currentTarget.dataset.url;setTimeout(d,3000)},onMessage:function(s){var i;try{i=JSON.parse(s.data);switch(i.state){case t.States.DOWNLOADING:this.cleanUi();this.showProgressUi();e('#progresssteps').css({width:i.download_percent+'%'}).text(i.download_percent+'%');break;case t.States.DONE:this.done(i.message);break}}catch(n){t.Restore.Functions.printMessageError(n.message,this.containerUi);r.call(this)}},onError:function(e){var s=JSON.parse(e.data);this.closeEventSource();switch(s.message){case t.States.NEED_DECRYPTION_KEY:this.cleanUi();this.decrypter&&this.decrypter.needDecryption(s.status);break;default:t.Restore.Functions.printMessageError(s.message,this.containerUi);r.call(this);break};return this},initializeEventSource:function(){if(!s.isUndefined(this.eventSource)){return};this.eventSource=new EventSource(i+'?action=download_backup_file&destination='+this.currentTarget.dataset.destination+'&jobid='+this.currentTarget.dataset.jobid+'&file='+this.currentTarget.dataset.file+'&local_file='+this.currentTarget.dataset.localFile+'&backwpup_action_nonce='+this.currentTarget.dataset.nonce);this.eventSource.onmessage=this.onMessage;this.eventSource.addEventListener('log',this.onError)},closeEventSource:function(){if(s.isUndefined(this.eventSource)){return};this.eventSource.close();this.eventSource=undefined},startDownload:function(e){e.preventDefault();this.currentTarget=e.target;this.showWaitingMessage();this.initializeEventSource()},decrypt:function(){this.cleanUi();this.decrypter&&this.decrypter.decrypt({backwpup_action_nonce:this.currentTarget.dataset.nonce,encrypted_file_path:this.currentTarget.dataset.localFile})},construct:function(e){var t=document.querySelector('#tb_container');if(!t){return!1};s.bindAll(this,'showWaitingMessage','hideWaitingMessage','showProgressUi','hideSuccessMsg','showSuccessMsg','done','onMessage','onError','initializeEventSource','closeEventSource','startDownload','addListeners','decrypt','hideNotice','cleanUi','init');this.containerUi=t;this.waitingUi=this.containerUi.querySelector('#download-file-waiting');this.progressUi=this.containerUi.querySelector('.progressbar');this.successUi=this.containerUi.querySelector('#download-file-success');this.currentTarget=undefined;this.eventSource=undefined;this.decrypter=e;return this},addListeners:function(){s.forEach(document.querySelectorAll('.backup-download-link'),function(e){e.addEventListener('click',this.startDownload)}.bind(this));e('#submit_decrypt_key').on('click',this.decrypt);e('body').on('thickbox:removed',function(){r.call(this)}.bind(this));if(this.decrypter){e('body').on(this.decrypter.ACTION_DECRYPTION_SUCCESS,this.done)}
else{};return this},init:function(){this.addListeners();return this}};n=Object.create(u);if(!s.isUndefined(t.DecrypterFactory)){a=t.DecrypterFactory(i,document.querySelector('#decrypt_key'),document.querySelector('#decryption_key'))};if(n.construct(a)){n.init()}}(window.jQuery,window._,window.BWU,window.ajaxurl,window.tb_remove));